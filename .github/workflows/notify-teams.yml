name: Teams Daily Digest Notification

on:
  push:
    branches: [main]
    paths:
      - 'AI Daily News/**'

jobs:
  notify-teams:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find today's digest
        id: find
        run: |
          # ê°€ì¥ ìµœê·¼ ì¶”ê°€/ë³€ê²½ëœ ë‹¤ì´ì œìŠ¤íŠ¸ íŒŒì¼ ì°¾ê¸°
          FILE=$(git diff --name-only HEAD~1 HEAD -- 'AI Daily News/' \
            | grep -E '[0-9]{4}-[0-9]{2}-[0-9]{2}\.md$' \
            | head -1)

          if [ -z "$FILE" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No digest file found in diff"
            exit 0
          fi

          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

          # ë‚ ì§œ ì¶”ì¶œ
          DATE=$(basename "$FILE" .md)
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Extract digest summary
        if: steps.find.outputs.skip != 'true'
        id: summary
        run: |
          FILE="${{ steps.find.outputs.file }}"

          # ê¸°ì‚¬ ìˆ˜ ì¶”ì¶œ (frontmatter article_count)
          COUNT=$(grep '^article_count:' "$FILE" | sed 's/article_count: //')
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          # ë†’ìŒ ì¤‘ìš”ë„ ë‰´ìŠ¤ ì œëª© ì¶”ì¶œ (#### ë¡œ ì‹œì‘í•˜ëŠ” ì¤„)
          HIGH=$(sed -n '/^### ğŸ”´ ë†’ìŒ/,/^### ğŸŸ¡ ë³´í†µ/{
            /^#### /{s/^#### /â€¢ /;p}
          }' "$FILE" | head -5)

          # ë³´í†µ ì¤‘ìš”ë„ ë‰´ìŠ¤ ê±´ìˆ˜
          MEDIUM_COUNT=$(sed -n '/^### ğŸŸ¡ ë³´í†µ/,/^### ğŸŸ¢ ë‚®ìŒ/{
            /^#### /p
          }' "$FILE" | wc -l | tr -d ' ')
          echo "medium_count=$MEDIUM_COUNT" >> $GITHUB_OUTPUT

          # ë‚®ìŒ ì¤‘ìš”ë„ ë‰´ìŠ¤ ê±´ìˆ˜
          LOW_COUNT=$(sed -n '/^### ğŸŸ¢ ë‚®ìŒ/,/^## ì œí’ˆ/{
            /^#### /p
          }' "$FILE" | wc -l | tr -d ' ')
          echo "low_count=$LOW_COUNT" >> $GITHUB_OUTPUT

          # ë©€í‹°ë¼ì¸ ì¶œë ¥
          {
            echo 'high<<EOF'
            echo "$HIGH"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Send Teams notification
        if: steps.find.outputs.skip != 'true'
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          DATE: ${{ steps.find.outputs.date }}
          COUNT: ${{ steps.summary.outputs.count }}
          HIGH: ${{ steps.summary.outputs.high }}
          MEDIUM_COUNT: ${{ steps.summary.outputs.medium_count }}
          LOW_COUNT: ${{ steps.summary.outputs.low_count }}
        run: |
          # ë†’ìŒ ë‰´ìŠ¤ë¥¼ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
          HIGH_FORMATTED=$(echo "$HIGH" | sed 's/$/\\n/' | tr -d '\n' | sed 's/\\n$//')

          # Adaptive Card JSON
          cat > /tmp/teams-card.json << CARD
          {
            "type": "message",
            "attachments": [{
              "contentType": "application/vnd.microsoft.card.adaptive",
              "content": {
                "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                "type": "AdaptiveCard",
                "version": "1.4",
                "body": [
                  {
                    "type": "TextBlock",
                    "size": "Large",
                    "weight": "Bolder",
                    "text": "ğŸ“° AI Daily Digest â€” ${DATE}"
                  },
                  {
                    "type": "ColumnSet",
                    "columns": [
                      {
                        "type": "Column",
                        "width": "auto",
                        "items": [{
                          "type": "TextBlock",
                          "text": "ğŸ“Š ì´ **${COUNT}ê±´**",
                          "spacing": "Small"
                        }]
                      },
                      {
                        "type": "Column",
                        "width": "auto",
                        "items": [{
                          "type": "TextBlock",
                          "text": "ğŸ”´ ë†’ìŒ | ğŸŸ¡ ${MEDIUM_COUNT}ê±´ | ğŸŸ¢ ${LOW_COUNT}ê±´",
                          "spacing": "Small"
                        }]
                      }
                    ]
                  },
                  {
                    "type": "TextBlock",
                    "text": "ğŸ”´ **ì£¼ìš” ë‰´ìŠ¤**",
                    "weight": "Bolder",
                    "spacing": "Medium",
                    "separator": true
                  },
                  {
                    "type": "TextBlock",
                    "text": "${HIGH_FORMATTED}",
                    "wrap": true,
                    "spacing": "Small"
                  }
                ],
                "actions": [
                  {
                    "type": "Action.OpenUrl",
                    "title": "ğŸ“‚ GitHubì—ì„œ ì „ì²´ ë³´ê¸°",
                    "url": "https://github.com/hyungjin1124/ai-research/blob/main/AI%20Daily%20News/$(echo ${DATE} | cut -c1-4)/$(echo ${DATE} | cut -c6-7)/${DATE}.md"
                  }
                ]
              }
            }]
          }
          CARD

          # Teams Webhook ì „ì†¡
          curl -s -H "Content-Type: application/json" \
               -d @/tmp/teams-card.json \
               "$TEAMS_WEBHOOK_URL"

          echo "âœ… Teams notification sent for ${DATE}"
